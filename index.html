<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Inventario Kanban</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom styles for drag and drop feedback */
        .dragging {
            opacity: 0.5;
            border: 2px dashed #3B82F6; /* Blue-500 */
        }
        .drag-over {
            background-color: #DBEAFE; /* Blue-100 */
        }
        /* Custom scrollbar for columns */
        .kanban-column {
            max-height: calc(100vh - 180px); /* Adjust based on header/footer height */
            overflow-y: auto;
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: #9CA3AF #F3F4F6; /* thumb and track color */
        }
        .kanban-column::-webkit-scrollbar {
            width: 8px;
        }
        .kanban-column::-webkit-scrollbar-track {
            background: #F3F4F6; /* Gray-100 */
            border-radius: 10px;
        }
        .kanban-column::-webkit-scrollbar-thumb {
            background-color: #9CA3AF; /* Gray-400 */
            border-radius: 10px;
            border: 2px solid #F3F4F6;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">
    <div id="app" class="min-h-screen flex flex-col">
        <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 shadow-lg rounded-b-xl">
            <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center">
                <h1 class="text-3xl font-bold mb-2 sm:mb-0">Gestor de Inventario del Hogar</h1>
                <div class="text-sm">
                    Tu ID de Usuario: <span id="userIdDisplay" class="font-semibold">Cargando...</span>
                </div>
            </div>
        </header>

        <div id="loadingIndicator" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl flex items-center space-x-3">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                <p class="text-lg font-semibold text-gray-700">Cargando datos...</p>
            </div>
        </div>

        <main class="container mx-auto p-4 flex-grow">
            <section class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Añadir Nuevo Artículo</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="itemName" class="block text-sm font-medium text-gray-600 mb-1">Nombre del Artículo</label>
                        <input type="text" id="itemName" placeholder="Ej: Arroz"
                               class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                    </div>
                    <div>
                        <label for="itemQuantity" class="block text-sm font-medium text-gray-600 mb-1">Cantidad</label>
                        <input type="number" id="itemQuantity" value="1" min="1"
                               class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                    </div>
                    <button id="addItemBtn"
                            class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 shadow-md">
                        <i class="fas fa-plus mr-2"></i>Añadir Artículo
                    </button>
                </div>
                <p id="addError" class="text-red-500 text-sm mt-2 hidden">El nombre del artículo no puede estar vacío.</p>
            </section>

            <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div id="column-pending" class="kanban-column bg-gray-50 p-4 rounded-lg shadow-md border border-gray-200">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2 border-gray-300">Pendiente</h3>
                    <div class="space-y-4 min-h-[100px]" data-column-id="pending">
                        </div>
                </div>

                <div id="column-purchased" class="kanban-column bg-gray-50 p-4 rounded-lg shadow-md border border-gray-200">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2 border-gray-300">Comprado</h3>
                    <div class="space-y-4 min-h-[100px]" data-column-id="purchased">
                        </div>
                </div>

                <div id="column-inStock" class="kanban-column bg-gray-50 p-4 rounded-lg shadow-md border border-gray-200">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2 border-gray-300">En Stock</h3>
                    <div class="space-y-4 min-h-[100px]" data-column-id="inStock">
                        </div>
                </div>

                <div id="column-outOfStock" class="kanban-column bg-gray-50 p-4 rounded-lg shadow-md border border-gray-200">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2 border-gray-300">Agotado</h3>
                    <div class="space-y-4 min-h-[100px]" data-column-id="outOfStock">
                        </div>
                </div>
            </section>
        </main>

        <div id="editModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/3">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Editar Artículo</h3>
                <label for="editItemName" class="block text-sm font-medium text-gray-600 mb-1">Nombre</label>
                <input type="text" id="editItemName" class="w-full p-3 border border-gray-300 rounded-md mb-4">
                <label for="editItemQuantity" class="block text-sm font-medium text-gray-600 mb-1">Cantidad</label>
                <input type="number" id="editItemQuantity" class="w-full p-3 border border-gray-300 rounded-md mb-4" min="1">
                <div class="flex justify-end space-x-3">
                    <button id="cancelEditBtn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400 transition duration-200">Cancelar</button>
                    <button id="saveEditBtn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-200">Guardar Cambios</button>
                </div>
            </div>
        </div>

        <div id="deleteConfirmModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/3">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Confirmar Eliminación</h3>
                <p class="text-gray-600 mb-6">¿Estás seguro de que quieres eliminar este artículo?</p>
                <div class="flex justify-end space-x-3">
                    <button id="cancelDeleteBtn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400 transition duration-200">Cancelar</button>
                    <button id="confirmDeleteBtn" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 transition duration-200">Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase configuration and app ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false;

        // Get DOM elements
        const itemNameInput = document.getElementById('itemName');
        const itemQuantityInput = document.getElementById('itemQuantity');
        const addItemBtn = document.getElementById('addItemBtn');
        const addError = document.getElementById('addError');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // Modals elements
        const editModal = document.getElementById('editModal');
        const editItemNameInput = document.getElementById('editItemName');
        const editItemQuantityInput = document.getElementById('editItemQuantity');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const saveEditBtn = document.getElementById('saveEditBtn');

        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        let currentEditingItem = null; // To store the item being edited/deleted

        // Initialize Firebase
        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate user
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdDisplay.textContent = currentUserId;
                    } else {
                        // Sign in anonymously if no custom token or if user signs out
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                            currentUserId = auth.currentUser?.uid || crypto.randomUUID();
                            userIdDisplay.textContent = currentUserId;
                        } catch (error) {
                            console.error("Error signing in:", error);
                            userIdDisplay.textContent = "Error de autenticación";
                            currentUserId = crypto.randomUUID(); // Fallback to a random ID
                        }
                    }
                    isAuthReady = true;
                    hideLoading();
                    if (currentUserId) {
                        setupRealtimeListener();
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                userIdDisplay.textContent = "Error de inicialización";
                hideLoading();
            }
        }

        // Show/hide loading indicator
        function showLoading() {
            loadingIndicator.classList.remove('hidden');
        }

        function hideLoading() {
            loadingIndicator.classList.add('hidden');
        }

        // Function to create a Kanban item card
        function createItemCard(item) {
            const card = document.createElement('div');
            card.id = `item-${item.id}`;
            card.draggable = true;
            card.classList.add('bg-white', 'p-4', 'rounded-lg', 'shadow-sm', 'border', 'border-gray-200', 'flex', 'flex-col', 'gap-2', 'cursor-grab');
            card.setAttribute('data-item-id', item.id);
            card.setAttribute('data-column-id', item.column);

            card.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="font-medium text-lg text-gray-800">${item.name}</span>
                    <div class="flex space-x-2">
                        <button class="edit-btn text-blue-500 hover:text-blue-700 transition duration-150" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-btn text-red-500 hover:text-red-700 transition duration-150" title="Eliminar">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
                <p class="text-gray-600 text-sm">Cantidad: <span class="font-semibold">${item.quantity}</span></p>
            `;

            // Add event listeners for drag and drop
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);

            // Add event listeners for edit and delete buttons
            card.querySelector('.edit-btn').addEventListener('click', () => openEditModal(item));
            card.querySelector('.delete-btn').addEventListener('click', () => openDeleteConfirmModal(item));

            return card;
        }

        // Render items to their respective columns
        function renderItems(items) {
            // Clear existing items from all columns
            document.querySelectorAll('.kanban-column > div').forEach(col => col.innerHTML = '');

            items.forEach(item => {
                const columnElement = document.querySelector(`[data-column-id="${item.column}"]`);
                if (columnElement) {
                    columnElement.appendChild(createItemCard(item));
                }
            });
        }

        // Firestore Real-time Listener
        function setupRealtimeListener() {
            if (!isAuthReady || !currentUserId) {
                console.log("Authentication not ready or userId not available for listener setup.");
                return;
            }

            // Changed collection path to a public one
            const itemsCollectionRef = collection(db, `artifacts/${appId}/public/data/inventoryItems`);
            onSnapshot(itemsCollectionRef, (snapshot) => {
                const items = [];
                snapshot.forEach(doc => {
                    items.push({ id: doc.id, ...doc.data() });
                });
                renderItems(items);
            }, (error) => {
                console.error("Error fetching real-time updates:", error);
            });
        }

        // Add New Item
        addItemBtn.addEventListener('click', async () => {
            const name = itemNameInput.value.trim();
            const quantity = parseInt(itemQuantityInput.value, 10);

            if (!name) {
                addError.classList.remove('hidden');
                return;
            }
            addError.classList.add('hidden');

            if (!isAuthReady || !currentUserId) {
                console.error("Authentication not ready. Cannot add item.");
                return;
            }

            try {
                showLoading();
                // Changed collection path to a public one
                const itemsCollectionRef = collection(db, `artifacts/${appId}/public/data/inventoryItems`);
                await addDoc(itemsCollectionRef, {
                    name: name,
                    quantity: quantity,
                    column: 'pending', // Default column for new items
                    // userId: currentUserId, // Removed userId from item data as it's now public
                    createdAt: new Date()
                });
                itemNameInput.value = '';
                itemQuantityInput.value = '1';
                hideLoading();
            } catch (e) {
                console.error("Error adding document: ", e);
                hideLoading();
            }
        });

        // Drag and Drop functionality
        let draggedItem = null;

        function handleDragStart(e) {
            draggedItem = e.target;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedItem.id);
            setTimeout(() => {
                draggedItem.classList.add('dragging');
            }, 0);
        }

        function handleDragEnd(e) {
            draggedItem.classList.remove('dragging');
            draggedItem = null;
        }

        document.querySelectorAll('.kanban-column > div').forEach(column => {
            column.addEventListener('dragover', e => {
                e.preventDefault(); // Allow drop
                column.classList.add('drag-over');
            });

            column.addEventListener('dragleave', () => {
                column.classList.remove('drag-over');
            });

            column.addEventListener('drop', async e => {
                e.preventDefault();
                column.classList.remove('drag-over');

                if (draggedItem) {
                    const newColumnId = column.getAttribute('data-column-id');
                    const itemId = draggedItem.getAttribute('data-item-id');

                    if (!isAuthReady || !currentUserId) {
                        console.error("Authentication not ready. Cannot move item.");
                        return;
                    }

                    try {
                        showLoading();
                        // Changed collection path to a public one
                        const itemDocRef = doc(db, `artifacts/${appId}/public/data/inventoryItems`, itemId);
                        await updateDoc(itemDocRef, {
                            column: newColumnId
                        });
                        hideLoading();
                    } catch (error) {
                        console.error("Error updating item column:", error);
                        hideLoading();
                    }
                }
            });
        });

        // Modal functions
        function openEditModal(item) {
            currentEditingItem = item;
            editItemNameInput.value = item.name;
            editItemQuantityInput.value = item.quantity;
            editModal.classList.remove('hidden');
        }

        function closeEditModal() {
            editModal.classList.add('hidden');
            currentEditingItem = null;
        }

        saveEditBtn.addEventListener('click', async () => {
            if (currentEditingItem) {
                const newName = editItemNameInput.value.trim();
                const newQuantity = parseInt(editItemQuantityInput.value, 10);

                if (!newName || newQuantity < 1) {
                    // Basic validation
                    // Replaced alert with console.log as alerts are not allowed
                    console.log("El nombre y la cantidad son obligatorios y la cantidad debe ser al menos 1.");
                    return;
                }

                if (!isAuthReady || !currentUserId) {
                    console.error("Authentication not ready. Cannot save changes.");
                    return;
                }

                try {
                    showLoading();
                    // Changed collection path to a public one
                    const itemDocRef = doc(db, `artifacts/${appId}/public/data/inventoryItems`, currentEditingItem.id);
                    await updateDoc(itemDocRef, {
                        name: newName,
                        quantity: newQuantity
                    });
                    closeEditModal();
                    hideLoading();
                } catch (error) {
                    console.error("Error updating item:", error);
                    hideLoading();
                }
            }
        });

        cancelEditBtn.addEventListener('click', closeEditModal);

        function openDeleteConfirmModal(item) {
            currentEditingItem = item;
            deleteConfirmModal.classList.remove('hidden');
        }

        function closeDeleteConfirmModal() {
            deleteConfirmModal.classList.add('hidden');
            currentEditingItem = null;
        }

        confirmDeleteBtn.addEventListener('click', async () => {
            if (currentEditingItem) {
                if (!isAuthReady || !currentUserId) {
                    console.error("Authentication not ready. Cannot delete item.");
                    return;
                }

                try {
                    showLoading();
                    // Changed collection path to a public one
                    const itemDocRef = doc(db, `artifacts/${appId}/public/data/inventoryItems`, currentEditingItem.id);
                    await deleteDoc(itemDocRef);
                    closeDeleteConfirmModal();
                    hideLoading();
                } catch (error) {
                    console.error("Error deleting item:", error);
                    hideLoading();
                }
            }
        });

        cancelDeleteBtn.addEventListener('click', closeDeleteConfirmModal);

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            showLoading();
            initializeFirebase();
        });
    </script>
</body>
</html>
